#!/bin/bash
# This script should NOT be included in a golden image. It is subject to change
# periodically. Use the aporeto_install script instead.

APOCTL_URL="https://download.aporeto.com/apoctl/linux/apoctl"
JQ_URL="https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64"
JWT_URL="https://github.com/aporeto-se/jwt/releases/download/v1.0/jwt"

function main() {
  [ $EUID -eq 0 ] || { err "Must be root"; return 2; }
  [ "$1" == "enforcerd" ] && { enforcerd_install_main $@; return $?; }
  [ "$1" == "apoctl" ] && { apoctl_install_main $@; return $?; }
  [ "$1" == "tools" ] && { tools_install_main $@; return $?; }
  [ "$1" == "all" ] && { all_install_main $@; return $?; }
  err "Usage: (enforcerd|apoctl|tools|all)"
}

function enforcerd_install_main() {
  [[ $ENFORCERD_NAMESPACE ]] || { err "Please set ENFORCERD_NAMESPACE and run again"; return 2; }
  enforcerd_install_flavor || { err "Install failed"; return 3; }
  enforcerd_install_common || { err "Install failed"; return 3; }
}

function apoctl_install_main() {
  curl -s -L -o /usr/bin/apoctl $APOCTL_URL || return 3
  chmod +x /usr/bin/apoctl || return 3
}

function tools_install_main() {
  curl -s -L -o /usr/bin/jq $JQ_URL || return 3
  chmod +x /usr/bin/jq || return 3
  curl -s -L -o /usr/bin/jwt $JWT_URL || return 3
  chmod +x /usr/bin/jwt || return 3
}

function all_install_main() {
  rc=0
  enforcerd_install_main || { err "enforcerd install failed"; rc=3; }
  apoctl_install_main || { err "apoctl install failed"; rc=3; }
  tools_install_main || { err "tools install failed"; rc=3; }
  return $rc
}

function enforcerd_install_flavor() {
  # Supported releases are Redhat (RHEL, CentOS, Fedora) and Debian (Ubuntu, etc)
  which yum > /dev/null 2>&1 && { enforcerd_install_yum; return $?; }
  which apt > /dev/null 2>&1 && { enforcerd_install_apt; return $?; }
  err "Sorry, I only support Redhat and Debian"
  return 3
}

function enforcerd_install_apt() {
  err "System type is Debian"
  curl -sSL https://download.aporeto.com/aporeto-packages.gpg | apt-key add - || return 3
  echo "deb [arch=$(dpkg --print-architecture)] https://repo.aporeto.com/ubuntu/$(lsb_release -cs) aporeto main" > /etc/apt/sources.list.d/aporeto.list || return 3
  apt update || return 3
  apt -y install python dnsutils zip unzip
  apt -y install enforcerd ||:
}

function enforcerd_install_yum() {
  err "System type is Redhat"
  local repo=/etc/yum.repos.d/Aporeto.repo
  echo "[Aporeto]" > $repo || return 3
  echo "name=aporeto" >> $repo || return 3
  echo "baseurl=https://repo.aporeto.com/centos/7" >> $repo || return 3
  echo "gpgkey=https://download.aporeto.com/aporeto-packages.gpg" >> $repo || return 3
  echo "gpgcheck=1" >> $repo || return 3
  echo "repo_gpgcheck=1" >> $repo || return 3
  echo "enabled=1" >> $repo || return 3
  yum -y install bind-utils zip unzip || return 3
  yum -y install enforcerd ||:
}

function enforcerd_install_common() {
  # Aporeto does not *yet* support IPv6. So we remove the IPv6 entry for localhost from the hosts file.
  # Commands like curl will try IPv6 first.
  echo "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4" > /etc/hosts || return 3
  systemctl enable enforcerd.service || return 3
  rm -rf /var/lib/aporeto
  rm -rf /var/log/enforcerd
  mv /etc/enforcerd.conf /etc/_enforcerd.conf
  echo "# Generated by Jodys install script" > /etc/enforcerd.conf
  echo "# The original file was moved to /etc/_enforcerd.conf" > /etc/enforcerd.conf
  echo "ENFORCERD_NAMESPACE=${ENFORCERD_NAMESPACE}" >> /etc/enforcerd.conf
}

err() { echo "$@" 1>&2; }

main $@
